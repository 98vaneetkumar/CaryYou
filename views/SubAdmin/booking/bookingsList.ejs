<div class="main-content">
  <section class="section">
    <div class="section-header">
      <h1> Booking List</h1>

    </div>
    <div class="section-body">
      <div class="col-12 col-md-6 col-lg-12">
        <div class="row">

          <div class="table-responsive  mt-3">
            <table id="myTable" class="table table-hover table-md">
              <thead>
                <tr style="background-color: #ebf2f2;">
                  <th scope="col">S No.</th>
                  <th scope="col">User</th>
                  <th scope="col">Provider</th>
                  <th scope="col">Services</th>
                  <th scope="col">Status</th>
                  <th scope="col">Action</th>
                </tr>
              </thead>
              <tbody class="table_data">
                <% if(bookingdata.length !=0){%>
                  <% bookingdata.forEach(function(data,i) { %>
                    <tr>
                      <td>
                        <%=1+i%>
                      </td>
                      <td>
                        <%=data.userId ? data.userId.name : "User not available" %>
                      </td>
                      <td>
                        <%=data.providerId ? data.providerId.name : "worker not assigned" %>
                      </td>
                      <td>
                        <%=data.serviceId ? data.serviceId.service : "N/A" %>
                      </td>
                      <% if(data.status==0 ) { %>
                        <td> <button id="userId_<%-data.id%>" class=" btn btn-sm btn-success status "
                            data-id="<%=data._id%>" value="0" disabled>Processing</button></td>
                        <% } else { %>
                          <td> <button id="userId_<%-data.id%>" class=" btn btn-sm btn-success status "
                              data-id="<%=data._id%>" value="1" disabled>Ongoing</button></td>
                          <% } %>
                            <td>
                              <a href="/subAdmin/viewBooking/<%=data._id%>" class="btn btn-sm bg-warning"><i class="fa fa-eye"
                                  aria-hidden="true"></i></a>
                              <!-- <a href="/editBooking/<%=data._id%>" class="btn btn-sm bg-warning"><i class="fas fa-edit"></i></a> -->
                              <button onclick="confirmDelete('<%=data._id%>')" class="btn btn-sm bg-danger"> <i
                                  class="fa fa-trash"></i> </button>
                            </td>
                    </tr>
                    <%})%>
                      <%}%>
              </tbody>
              <tbody class="append_tbody">

              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>


<script>

  function filterData(elem) {
    $.ajax({
      type: "post",
      url: "/filterData",
      data: { status: elem.value },
      success: function (result) {
        // console.log(data);
        // return
        $(".table_data").addClass("d-none")
        var html = ``
        result.forEach((data, i) => {
          console.log(data, "lppplpllpplpl");
          html += `<tr>
                          <td>${1 + i}</td>
                          <td>${data.userId ? data.userId.firstname : ""}</td>
                        <td>${data.job_type ? data.job_type.name : ""}</td>
                          <td>${data.workerId ? data.workerId.firstname : ""}</td>
                     
                          <td>
                            <img src="${data.image}" width="45px" height="40px" type="submit" style="cursor:pointer;">
                          </td>
                          <td>
                            <select onchange=changeStatus(this,'${data._id}') class="form-control statuschange" ${data.job_status == '2' || data.job_status == '4' ? "disabled" : ""}"
                            >
                              <option value="0" ${data.job_status == 0 ? "selected" : ""}>Pending</option>
                              <option value="1" ${data.job_status == 1 ? "selected" : ""}>On going</option>
                              <option value="2" ${data.job_status == 2 ? "selected" : ""}>Completed</option>
                              <option value="3" ${data.job_status == 3 ? "selected" : ""}>Completed</option>
                              <option value="4" ${data.job_status == 4 ? "selected" : ""}>Completed</option>
                              <option value="5" ${data.job_status == 5 ? "selected" : ""}>Completed</option>
                              <option value="6" ${data.job_status == 6 ? "selected" : ""}>Completed</option>
                              <option value="7" ${data.job_status == 7 ? "selected" : ""}>Completed</option>
                            </select>
                          </td>
                          <td>
                          <a href="/view_booking/${data._id}" class="btn btn-sm bg-info"><i class="fa fa-eye" aria-hidden="true"></i></a>
                          <a href="/edit_booking/${data._id}" class="btn btn-sm bg-warning"><i class="fas fa-edit"></i></a>
                          <button onclick="confirmDelete('${data._id}')" class="btn btn-sm bg-danger"> <i class="fa fa-trash"></i> </button>
                          </td>
                        </tr>`
        })
        $(".append_tbody").html(html)

      }
    });

  }

  function changeStatus(elem, id) {
    var value = elem.value

    $.ajax({
      type: "post",
      url: "/bookingStatus",
      data: {
        id: id,
        value
      },
      success: function (data) {
        console.log(data)
        window.location.reload();
      },
      error: function (err) {
        console.log(err, "errrrrrrrrr")
      }
    });
  }


  setTimeout(function () {
    $("div.msg").fadeOut();
  }, 2000);
</script>

<script>
  $(document).ready(function () {
    // alert("ready!");
  });

  $(document).ready(function () {
    $('#myTable').DataTable({
      dom: 'Bfrtip',
      buttons: [
        'excel', 'pdf', 'print'
      ]
    });
  });


  function confirmDelete(id) {

    const swalWithBootstrapButtons = Swal.mixin({
      customClass: {
        confirmButton: 'btn btn-warning',
        cancelButton: 'btn btn-info'
      },
      buttonsStyling: true

    })

    // console.log("------------------------------result------", id);

    swalWithBootstrapButtons.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, delete it!',
      cancelButtonText: 'No, cancel!',
      reverseButtons: true
    }).then((isConfirm) => {
      // console.log(isConfirm)
      // return
      if (isConfirm.isConfirmed) {
        // alert('asd')
        $.ajax({
          url: "/deleteBooking/:id",
          type: 'delete',
          data: {
            id: id
          },
          success: function (result) { }
        });
        swalWithBootstrapButtons.fire(
          'Deleted!',
          'The Booking has been deleted .',
          'success'
        ).then(() => {
          location.reload();
        })
      } else {
        swalWithBootstrapButtons.fire(
          'Cancelled',
          'The Booking is safe :)',
          'error'
        )
      }
    })

  }
</script>


<script>



  $('.statuschange').on("change", (function () {
    var id = $(this).attr('data-id');
    var value = $(this).val();
    $.ajax({
      type: "post",
      url: "/booking_status",
      data: {
        id: id,
        value
      },
      success: function (data) {
        console.log(data)
        window.location.reload();
      },
      error: function (err) {
        console.log(err, "errrrrrrrrr")
      }
    });
  }));

</script>