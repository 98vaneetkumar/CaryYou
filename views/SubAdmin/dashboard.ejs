<!-- Main Content -->
<div class="main-content">
  <section class="section">
    <<div class="section-header d-flex justify-content-between align-items-center">
      <h1>SubAdmin Dashboard</h1>
      <div class="filter-options">
        <select id="filter" class="form-control">
          <option value="all">All</option>
          <option value="today">Today</option>
          <option value="weekly">This Week</option>
          <option value="monthly">This Month</option>
          <option value="3months">Last 3 Months</option>
          <option value="6months">Last 6 Months</option>
          <option value="1year">Last 1 Year</option>
          <option value="5years">Last 5 Years</option>
        </select>
      </div>
    </div>    
    <div class="row">

      <div id="loader" class="setting-gear-loader" style="display: none">
        <div class="gear"></div>
      </div>
      <div id="restaurant_id" data-value="<%= restaurantId._id %>" hidden></div>
      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-top">
        <a href="/subAdmin/order_list">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #33cc33, #66ff66)"
          >
            <div class="card-icon" style="background: rgba(44, 176, 44, 0.8)">
              <i class="fas fa-box"></i>
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4  style="color: white; font-weight: bold"><b>Orders</b></h4>
              </div>
              <div id="orders" value="<%= orders %>" class="card-body" style="color: white; font-weight: bold">
                <%= orders %>
              </div>
            </div>
          </div>
        </a>
      </div>

      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-top">
        <a href="/subAdmin/pending_order_list">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #cc9933, #ffd466)"
          >
            <div class="card-icon" style="background: rgba(163, 135, 41, 0.8)">
              <i class="fas fa-hourglass-half"></i>
              <!-- Updated icon -->
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">
                  <b>Pending Orders</b>
                </h4>
              </div>
              <div  id="pendingorders" value="<%= pendingorders %>" class="card-body" style="color: white; font-weight: bold">
                <%= pendingorders %>
              </div>
            </div>
          </div>
        </a>
      </div>

      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-top">
        <a href="/subAdmin/active_order_list">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #ffc300, #ffd966)"
          >
            <div class="card-icon" style="background: rgba(204, 153, 51, 0.8)">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4  style="color: white; font-weight: bold">Active Orders</h4>
              </div>
              <div id="activeorders" value="<%= activeorders %>" class="card-body" style="color: white; font-weight: bold">
                <%= activeorders %>
              </div>
            </div>
          </div>
        </a>
      </div>

      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-top">
        <a href="/subAdmin/delivered_order_list">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #33a1ff, #66c2ff)"
          >
            <div class="card-icon" style="background: rgba(51, 128, 204, 0.8)">
              <i class="fas fa-truck"></i>
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">
                  Delivered Orders
                </h4>
              </div>
              <div  id="deliveredorders" value="<%= deliveredorders %>" class="card-body" style="color: white; font-weight: bold">
                <%= deliveredorders %>
              </div>
            </div>
          </div>
        </a>
      </div>

      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-left">
        <a href="/subAdmin/cancel_order_list">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #ff5733, #ff8c66)"
          >
            <div class="card-icon" style="background: rgba(204, 85, 51, 0.8)">
              <i class="fas fa-ban"></i>
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">
                  Cancelled Orders
                </h4>
              </div>
              <div id="cancelledorders" value="<%= cancelledorders %>" class="card-body" style="color: white; font-weight: bold">
                <%= cancelledorders %>
              </div>
            </div>
          </div>
        </a>
      </div>

      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-left">
        <a href="/subAdmin/restaurant_category">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #16a085, #48c9b0)"
          >
            <div class="card-icon" style="background: rgba(22, 160, 133, 0.8)">
              <i class="fas fa-tags"></i>
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">Categories</h4>
              </div>
              <div id="categories" value="<%= categories %>" class="card-body" style="color: white; font-weight: bold">
                <%= categories %>
              </div>
            </div>
          </div>
        </a>
      </div>

      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-right">
        <a href="/subAdmin/restaurant_subCategory">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #2980b9, #5dade2)"
          >
            <div class="card-icon" style="background: rgba(41, 128, 185, 0.8)">
              <i class="fas fa-tag"></i>
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">Sub Categories</h4>
              </div>
              <div id="subcategories" value="<%= subcategories %>" class="card-body" style="color: white; font-weight: bold">
                <%= subcategories %>
              </div>
            </div>
          </div>
        </a>
      </div>

      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-right">
        <a href="/subAdmin/restaurant_product">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #cb894c, #dfa172)"
          >
            <div class="card-icon" style="background: rgba(184, 128, 59, 0.8)">
              <i class="fas fa-box-open"></i>
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">Products</h4>
              </div>
              <div id="products" value="<%= products %>"  class="card-body" style="color: white; font-weight: bold">
                <%= products %>
              </div>
            </div>
          </div>
        </a>
      </div>


      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-left">
        <a href="#">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #8e44ad, #c39bd3)"
          >
            <div class="card-icon" style="background: rgba(142, 68, 173, 0.8)">
              <i class="fas fa-money-bill"></i>
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">Accounting</h4>
              </div>
              <div id="accounting" value="<%= accounting %>"   class="card-body" style="color: white; font-weight: bold">
                <%= accounting %>
              </div>
            </div>
          </div>
        </a>
      </div>

      <!-- Services Card -->
      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-right">
        <a href="/subAdmin/bannerList">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #33cc99, #1de380)"
          >
            <div class="card-icon" style="background: rgba(38, 151, 114, 0.8)">
              <i class="fas fa-chess-board"></i>
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold"><b>Banners</b></h4>
              </div>
              <div id="banners" value="<%= banners %>"  class="card-body" style="color: white; font-weight: bold">
                <%= banners %>
              </div>
            </div>
          </div>
        </a>
      </div>  

      <!-- Contact Us Card -->
      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-right">
        <a href="#">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #33cc33, #66ff66)"
          >
            <div class="card-icon" style="background: rgba(44, 176, 44, 0.8)">
              <i class="far fa-address-book"></i>
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">
                  <b>Contact Us</b>
                </h4>
              </div>
              <div id="contactus" value="<%= contactus %>" class="card-body" style="color: white; font-weight: bold">
                <%= contactus %>
              </div>
            </div>
          </div>
        </a>
      </div>
    </div>


  </section>
  <!-- <div class="row">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h4>Category, SubCatgory, and Products</h4>
        </div>
        <div class="card-body">
          <canvas id="userGraph"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h4>Order Statistics</h4>
        </div>
        <div class="card-body">
          <canvas id="orderGraph"></canvas>
        </div>
      </div>
    </div>
  </div> -->
</div>
<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->

<style>
  .section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.filter-options {
  margin-left: auto;
  max-width: 200px; /* Optional: Adjust as needed */
}
</style>

<script>
  setTimeout(function () {
    $("div.msg").fadeOut();
  }, 2000);
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

<script>
  const filterDropdown = document.getElementById("filter");
// Initial data setup for graphs
let categoryCount =
    parseInt(document.getElementById("categories").textContent) || 0;
  let subCategoryCount =
    parseInt(document.getElementById("subcategories").textContent) || 0;
  let productCount =
    parseInt(document.getElementById("products").textContent) || 0;
  let pendingOrderCount =
    parseInt(document.getElementById("pendingorders").textContent) || 0;
  let activeOrderCount =
    parseInt(document.getElementById("activeorders").textContent) || 0;
  let cancelledOrderCount =
    parseInt(document.getElementById("cancelledorders").textContent) || 0; 
  // Loader Element
  const loader = document.getElementById("loader");

  // Show loader
  function showLoader() {
    if (loader) loader.style.display = "block";
  }

  // Hide loader
  function hideLoader() {
    if (loader) loader.style.display = "none";
  }

 // Update card data dynamically

  function updateCardData(data) {
    document.getElementById("banners").textContent = data.banners||0
    document.getElementById("orders").textContent = data.orders || 0;
    document.getElementById("pendingorders").textContent =
      data.pendingOrders || 0;
    document.getElementById("activeorders").textContent =
      data.activeOrders || 0;
    document.getElementById("deliveredorders").textContent =
      data.deliveredOrders || 0;
    document.getElementById("cancelledorders").textContent =
      data.cancelledOrders || 0;
    document.getElementById("categories").textContent = data.category || 0;
    document.getElementById("subcategories").textContent =
      data.subCategory || 0;
    document.getElementById("products").textContent = data.products || 0;


    categoryCount = data.category || 0;
      subCategoryCount = data.subCategory || 0;
      productCount = data.products || 0;
      pendingOrderCount = data.pendingOrders || 0;
      activeOrderCount = data.activeOrders || 0;
      deliveredOrderCount = data.deliveredOrders || 0;
      cancelledOrderCount = data.cancelledOrders || 0;

      // Update charts
      userGraph.data.datasets[0].data = [
        categoryCount,
        subCategoryCount,
        productCount,
      ];
      userGraph.update();

      orderGraph.data.datasets[0].data = [
        pendingOrderCount,
        activeOrderCount,
        deliveredOrderCount,
        cancelledOrderCount,
      ];
      orderGraph.update();

  }

  let userGraph, orderGraph;
 // Initialize Charts
 function initializeCharts() {
    const userGraphCtx = document.getElementById("userGraph").getContext("2d");
    const orderGraphCtx = document
      .getElementById("orderGraph")
      .getContext("2d");

    // User Graph setup
    userGraph = new Chart(userGraphCtx, {
      type: "bar",
      data: {
        labels: ["Category", "SubCategory", "Products"],
        datasets: [
          {
            label: "Count",
            data: [data.category, data.subCategory, data.products], // Initial data
            backgroundColor: [
              "#6666ff", // Category (solid blue)
              "#33cccc", // SubCategory (solid cyan)
              "#33cc99", // Products (solid greenish)
            ],
            borderColor: [
              "#4444ff", // Category border (darker blue)
              "#33aaaa", // SubCategory border (darker cyan)
              "#33aa88", // Products border (darker greenish)
            ],
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: { display: true, text: "Category, SubCategory, and Product" },
        },
      },
    });

    // Order Graph setup
    orderGraph = new Chart(orderGraphCtx, {
      type: "doughnut",
      data: {
        labels: [
          "Pending Orders",
          "Active Orders",
          "Delivered Orders",
          "Cancelled Orders",
        ],
        datasets: [
          {
            label: "Orders",
            data: [
              pendingOrderCount,
              activeOrderCount,
              deliveredOrderCount,
              cancelledOrderCount,
            ], // Initial data
            backgroundColor: [
              "#e68900", // Pending Orders (darker orange)
              "#ffc300", // Active Orders (red-orange)
              "#33a1ff", // Delivered Orders (light blue)
              "#ff5733", // Cancelled Orders (yellow)
            ],
            borderColor: [
              "#d39e00", // Pending Orders border (darker yellow)
              "#e1a700", // Active Orders border (darker red-orange)
              "#267bbf", // Delivered Orders border (darker blue)
              "#d14b17", // Cancelled Orders border (darker yellow)
            ],
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          title: { display: true, text: "Order Statistics" },
        },
      },
    });
  }

  // Fetch data and update dashboard
  async function fetchData(filter = null) {
    showLoader(); // Show loader

    try {
      const restaurantId =
        document.getElementById("restaurant_id").dataset.value;

      const selectedFilter = filter || filterDropdown.value;

      const response = await fetch("/SubAdmin/restaurantDashboardFilter", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ filter: selectedFilter, id: restaurantId }),
      });

      if (!response.ok) {
        throw new Error(`API error with status: ${response.status}`);
      }

      const data = await response.json();
      // Update card content
      updateCardData(data);
    } catch (error) {
      console.error("Error fetching data:", error);
    } finally {
      hideLoader(); // Hide loader
    }
  }

  // Event listener for dropdown changes
  filterDropdown.addEventListener("change", async () => {
    await fetchData();
  });

  // // Initialize dashboard on page load
  // document.addEventListener("DOMContentLoaded", async() => {
  //   await fetchData(); // Initial data fetch
  // });
    // Initialize charts and set initial data on page load
    document.addEventListener("DOMContentLoaded", () => {
    initializeCharts(); // Initialize charts
    fetchData(); // Fetch initial data
  });
</script>
