<div class="main-content">
  <section class="section">
    <div class="section-header">
      <h1>User Detail</h1>
      <div class="section-header-breadcrumb">
        <div class="breadcrumb-item active">
          <a href="/admin/dashboard">Dashboard</a>
        </div>
        <div class="breadcrumb-item"><a href="/admin/user_list">Users</a></div>
        <div class="breadcrumb-item">User Detail</div>
      </div>
    </div>
    <div class="section-body">
      <div class="card">
        <form action="" method="post" enctype="multipart/form-data">
          <div class="row mt-sm-4 justify-content-center">
            <div class="col-12 col-md-12 col-lg-4">
              <div class="card profile-widget">
                <div class="profile-widget-header text-center py-3">
                  <img
                    alt="image"
                    width="200"
                    height="200"
                    id="blah"
                    src="<%= viewuser.image ? viewuser.image : 'https://avatar.iran.liara.run/public/boy?username=Ash' %>"
                    class="profile_img rounded-circle"
                  />
                </div>
              </div>
            </div>
            <div class="col-12 col-md-12 col-lg-7">
              <div class="card-body">
                <div class="form-group">
                  <label
                    class="col-form-label text-md-right col-12 col-md-5 col-lg-3"
                  >
                    Name</label
                  >
                  <div class="col-sm-12 col-md-12">
                    <input
                      type="text"
                      name="name"
                      value="<%=viewuser.fullName%>"
                      class="form-control"
                      disabled
                    />
                  </div>
                </div>
           
                <div class="form-group">
                  <label
                    class="col-form-label text-md-right col-12 col-md-3 col-lg-3"
                    >Email</label
                  >
                  <div class="col-sm-12 col-md-12">
                    <input
                      type="email"
                      name="email"
                      value="<%=viewuser.email%>"
                      class="form-control"
                      disabled
                    />
                  </div>
                </div>
                <div class="form-group">
                  <label
                    class="col-form-label text-md-right col-12 col-md-3 col-lg-3"
                    >Phone</label
                  >
                  <div class="col-sm-12 col-md-12">
                    <input
                      type="text"
                      name="phone"
                      value="<%=viewuser.countryCode%> <%=viewuser.phoneNumber%> "
                      class="form-control"
                      disabled
                    />
                  </div>
                </div>
              
                <br />
                <div class="form-group">
                  <div class="col-sm-12 col-md-12 text-right">
                    <a href="/admin/user_list" class="btn btn-info">Back</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </section>
</div>
<div class="main-content">
  <section class="section">
    <div class="section-header">
      <div class="d-flex justify-content-between align-items-center w-100">
        <h1>User Dashboard (<%=viewuser.fullName%>)</h1>
        <div class="filter-options">
          <select id="filter" class="form-control">
            <option value="all">All</option>
            <option value="today">Today</option>
            <option value="weekly">This Week</option>
            <option value="monthly">This Month</option>
            <option value="3months">Last 3 Months</option>
            <option value="6months">Last 6 Months</option>
            <option value="1year">Last 1 Year</option>
            <option value="5years">Last 5 Years</option>
          </select>
        </div>
      </div>
    </div>
    <div class="mb-3">
      <a href="/admin/user_list" class="btn btn-dark">
        <i class="fas fa-arrow-left"></i> Back
      </a>
    </div>
    <div class="row">
      <div id="loader" class="setting-gear-loader" style="display: none;">
        <div class="gear"></div>
      </div>
      <div id="user_id" data-value="<%= viewuser._id %>" hidden></div>
      <!-- Orders Card -->
      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-left">
        <a href="/admin/user_order_list/<%= viewuser._id %>">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #e7b17c, #ff6600)"
          >
            <div class="card-icon" style="background: rgba(255, 102, 0, 0.8)">
              <i class="fas fa-box-open"></i> <!-- Changed to 'fa-box-open' -->
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold"><b>Orders</b></h4>
              </div>
              <div class="card-body" id="orders" value="<%= orders %>" style="color: white; font-weight: bold">
                <%= orders %>
              </div>
            </div>
          </div>
        </a>
      </div>
      
      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-left">
        <a href="/admin/user_pending_order_list/<%= viewuser._id %>">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #33cc99, #66cc99)"
          >
          <div class="card-icon" style="background: rgba(38, 151, 114, 0.8)">
            <i class="fas fa-clock"></i>
          </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">Pending Orders</h4>
              </div>
              <div class="card-body" id="pendingOrders" value="<%= pendingOrders %>" style="color: white; font-weight: bold">
                <%= pendingOrders %>
              </div>
            </div>
          </div>
        </a>
      </div>
      
      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-left">
        <a href="/admin/user_success_order_list/<%= viewuser._id %>">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #66ff66, #33cc33)"
          >
            <div class="card-icon" style="background: rgba(51, 204, 51, 0.8)">
              <i class="fas fa-check-circle"></i> <!-- Changed to 'fa-check-circle' -->
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">Success Orders</h4>
              </div>
              <div class="card-body" id="successOrders" value="<%= successOrders %>" style="color: white; font-weight: bold">
                <%= successOrders %>
              </div>
            </div>
          </div>
        </a>
      </div>
      
      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-right">
        <a href="/admin/user_cancel_order_list/<%= viewuser._id %>">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #ff6666, #ff3333)"
          >
            <div class="card-icon" style="background: rgba(231, 57, 26, 0.8)">
              <i class="fas fa-times-circle"></i> <!-- Changed to 'fa-times-circle' -->
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">Cancelled Orders</h4>
              </div>
              <div class="card-body" id="cancelledOrders" value="<%= cancelledOrders %>" style="color: white; font-weight: bold">
                <%= cancelledOrders %>
              </div>
            </div>
          </div>
        </a>
      </div>
      
      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-right">
        <!-- <a href="/admin/user_all_rides_list/<%= viewuser._id %>"> -->
        <a href="#">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #ffcc00, #ff9900)"
          >
            <div class="card-icon" style="background: rgba(255, 140, 0, 0.8)">
              <i class="fas fa-car-side"></i> <!-- Changed to 'fa-car-side' -->
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">Total Rides</h4>
              </div>
              <div class="card-body" id="totalRides" value="<%= totalRides %>" style="color: white; font-weight: bold">
                <%= totalRides %>
              </div>
            </div>
          </div>
        </a>
      </div>
      
      <div class="col-lg-3 col-md-6 col-sm-6 col-12 animate-left">
        <!-- <a href="/admin/user_all_spend_list/<%= viewuser._id %>"> -->
          <a href="#">
          <div
            class="card card-statistic-1"
            style="background: linear-gradient(135deg, #3399ff, #66ccff)"
          >
            <div class="card-icon" style="background: rgba(0, 123, 255, 0.8)">
              <i class="fas fa-wallet"></i> <!-- Changed to 'fa-wallet' -->
            </div>
            <div class="card-wrap">
              <div class="card-header">
                <h4 style="color: white; font-weight: bold">Total Spend</h4>
              </div>
              <div class="card-body" id="totalSpend" value="<%= totalSpend %>" style="color: white; font-weight: bold">
                <%= totalSpend %>
              </div>
            </div>
          </div>
        </a>
      </div>
      
      
     
    </div>
  </section>

 <!-- Main Container -->
<div class="container-fluid">
  <div class="row">
    <!-- User Graph -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h4>User Statistics</h4>
        </div>
        <div class="card-body">
          <canvas id="userGraph"></canvas>
        </div>
      </div>
    </div>


    <!-- Graph for Orders -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h4>Order Statistics</h4>
        </div>
        <div class="card-body">
          <canvas id="orderGraph"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
    const filterDropdown = document.getElementById("filter");
    const loader = document.getElementById("loader");

    const userId = document.getElementById("user_id").getAttribute("data-value");

    let Orders= parseInt(document.getElementById("orders").textContent)||0
    let cancelledOrders= parseInt(document.getElementById("cancelledOrders").textContent)||0
    let successOrders=parseInt(document.getElementById("successOrders").textContent)||0
    let pendingOrders=parseInt(document.getElementById("pendingOrders").textContent)||0
 

          // Show loader
      function showLoader() {
        if (loader) loader.style.display = "block";
      }

      // Hide loader
      function hideLoader() {
        if (loader) loader.style.display = "none";
      }
      let userGraph,orderGraph;

      function initializeCharts(){
        const userGraphCtx = document.getElementById("userGraph").getContext("2d");
        const orderGraphCtx = document.getElementById("orderGraph").getContext("2d");
      // User Graph setup (Static Data)
        userGraph = new Chart(userGraphCtx, {
          type: "bar",
          data: {
            labels: ["Total Orders", "Cancelled Orders"],
            datasets: [
              {
                label: "Count",
                data: [Orders, cancelledOrders], // Static data
                backgroundColor: ["#6666ff", "#33cc99"],
                borderColor: ["#4444ff", "#33aa99"],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: "User Order Statistics" },
            },
          },
        });

        // Order Graph setup (Static Data)
        orderGraph = new Chart(orderGraphCtx, {
          type: "doughnut",
          data: {
            labels: [
              "Success Orders",
              "Cancelled Orders",
              "Pending Orders",
            ],
            datasets: [
              {
                label: "Orders",
                // date:[successOrders,cancelledOrders,pendingOrders],
                data: [successOrders, cancelledOrders, pendingOrders], // Static data
                backgroundColor: ["#007bff", "#dc3545", "#ffc107"],
                borderColor: ["#0056b3", "#a71d2a", "#d39e00"],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "bottom" },
              title: { display: true, text: "Order Statistics" },
            },
          },
        });

  
      }


        // Fetch data and update charts
  async function fetchData(filter = null) {
    showLoader(); // Show loader before starting the fetch process

    try {
      const selectedFilter = filterDropdown.value;
      const response = await fetch("/admin/user_dashboardFilter", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ filter: selectedFilter,id:userId }),
      });

      const data = await response.json();

      document.getElementById("orders").textContent=data.orders;
      document.getElementById("pendingOrders").textContent=data.pendingOrders;
      document.getElementById("successOrders").textContent=data.successOrders;
      document.getElementById("cancelledOrders").textContent=data.cancelledOrders;
      document.getElementById("totalRides").textContent=data.totalRides;
      document.getElementById("totalSpend").textContent=data.totalSpend;
    
        // Update chart data
        userGraph.data.datasets[0].data = [data.orders, data.cancelledOrders];
        userGraph.update();

        orderGraph.data.datasets[0].data = [
          data.successOrders,
          data.cancelledOrders,
          data.pendingOrders,
        ];
        orderGraph.update();



     } catch (error) {
      console.error("Error fetching data:", error);
    } finally {
      hideLoader(); // Always hide loader once fetch process is complete
    }
  }

  // Event listener for dropdown changes
  filterDropdown.addEventListener("change", async () => {
    await fetchData(); // Fetch and update data based on selected filter
  });

  // Initialize charts and set initial data on page load
  document.addEventListener("DOMContentLoaded", () => {
    initializeCharts(); // Initialize charts
    fetchData(); // Fetch initial data
  });
 

</script>
